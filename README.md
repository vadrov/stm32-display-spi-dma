Copyright (C) 2019 - 2022, VadRov, all right reserved.
 
# Библиотека управления дисплеями по SPI с DMA. Release 1.4
 
Управление подключенным дисплеем с интерфейсом spi к микроконтроллеру семейства stm32f4 с поддержкой DMA, плавным изменением яркости подсветки
посредством pwm. Поддерживаются дисплеи как с выводом CS, так и без него. Доступен выбор механизма управления выделением памяти: статическое или динамическое (см. файл display.h)
 
В библиотеке (папка Display_spi_LL) представлены низкоуровневые драйвера для дисплеев с контроллерами
st7789 и ili9341. Для подключения дисплея по spi c иным контроллером необходимо по примеру этих драйверов написать
свой низкоуровневый драйвер со строками инициализации и т.п., обратившись к спецификации соответствующего
контроллера дисплея.
 
Доступны графические примитивы (точка, линия, прямоугольник и т.д.) и вывод текста. Доступно подключение шрифтов пользователя.
 
Библиотека не использует HAL, а базируется на CMSIS и LL.
 
В качестве примера, в коде проекта, созданного в среде STM32CudeIDE, представлено подключение дисплеев с контроллерами 
ST7789 и ILI9341 к микроконтроллеру STM32F401CCU6 по SPI с DMA. Демонстрируется преимущество использования DMA.
 
Как использовать библиотеку и настроить проект в среде STM32CudeIDE подробно рассказано в видео:
[![Watch the video](https://img.youtube.com/vi/8tIJ16riJqo/maxresdefault.jpg)](https://youtu.be/8tIJ16riJqo)
Upd.: Замечание к видео (там старый релиз библиотеки). Новый релиз библиотеки требует:
- Настройки DMA не в режиме Circular, как в видео, а в режиме Normal.
- Создание обработчика нового дисплея осуществляется функцией LCD_DisplayAdd, создающей и добавляющей дисплей в список дисплеев. 
Этот список объявлен в библиотеке глобальной переменной LCD. После первого вызова указанной функции необходимо переназначать эту переменную, т.е
записать, например, такой код:
 
*LCD = LCD_DisplayAdd (LCD, параметры дисплея...);* для варианта с динамическим выделением памяти
 
*LCD = LCD_DisplayAdd (LCD, &lcd1, параметры дисплея...);* для варианта со статическим выделением памяти
 
В демо-проекте (см. файл main.c) показаны варианты инициализации дисплея при использовании динамического и статического выделения памяти

**Если есть проблемы, вызванные потерей связи с контроллером дисплея (зависания дисплея, "каша" и т.п.), то проверьте есть ли подтяжка к питанию (pull_up) линий sck и mosi.** Например, настройка gpio, используемых spi, в виде:

  /* SPI1 GPIO Configuration
  PA5   ------> SPI1_SCK
  
  PA7   ------> SPI1_MOSI */
  
  GPIO_InitStruct.Pin = LCD_SCL_Pin|LCD_SDA_Pin;
  
  GPIO_InitStruct.Mode = LL_GPIO_MODE_ALTERNATE;
  
  GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_VERY_HIGH;
  
  GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
  
  **GPIO_InitStruct.Pull = LL_GPIO_PULL_UP;**   /* Подтяжка к питанию есть */
  
  GPIO_InitStruct.Alternate = LL_GPIO_AF_5;
  
  LL_GPIO_Init(GPIOA, &GPIO_InitStruct);
  
**Если не помогает подтяжка к питанию**, то причина потерь связи может быть вызвана большой скоростью spi, которая не поддерживается контроллером дисплея либо длинными проводниками, соединяющими дисплей с микроконтроллером, наводками от каких-либо помехосоздающих устройств. 

Проблемы связи также могут быть вызваны **пульсирующим питанием модуля дисплея**. Возможно, в параллель питающих проводников дисплея потребуется установить электролитический конденсатор емкостью около 100 мкф. 

Также проблемы могут быть вызваны неправильным питающим напряжением дисплея. Так, например, популярные дисплеи с контроллерами ili9341 имеют на плате встроенный преобразователь напряжения 3,3 В, и должны запитываться от напряжения около 5 В. При попытке запитать эти модули от напряжения 3,3 В, выработанные преобразователем платы микроконтроллера, можно получить нестабильную работу дисплея на скорости spi свыше 10 - 20 Мбит/с. В тоже время, следует помнить, что популярные IPS дисплеи 1,3' 240х240 px на базе контроллера st7789 питаются напряжением 3.3 В. 

**Всегда сверяйте с документацией питающее напряжение модуля дисплея!**

Автор: **VadRov**

Контакты: [Youtube](https://www.youtube.com/c/VadRov) [Дзен](https://zen.yandex.ru/vadrov) [VK](https://vk.com/vadrov) [Telegram](https://t.me/vadrov_channel)

Донат: [Поддержать автора](https://yoomoney.ru/to/4100117522443917)
